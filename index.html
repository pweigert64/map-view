<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpine Photo Map v21</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
	
    <script src="config.js"></script>
    
    <script>
        // Force the browser to get the freshest data.js
        const dataScript = document.createElement('script');
        dataScript.src = "data.js?v=" + Date.now();
        document.head.appendChild(dataScript);
    </script>
	
    <style>
        html, body, #map-container { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; background: #e5e7eb; }
        #floating-controls { position: absolute; top: 70px; right: 15px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        #filter-controls-panel { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); min-width: 240px; display: none; flex-direction: column; gap: 12px; border: 1px solid #e5e7eb; }
        #filter-toggle { background: #4f46e5; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 3px solid white; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .filter-button { padding: 8px; font-size: 0.75rem; font-weight: 700; border-radius: 8px; cursor: pointer; border: 1px solid #d1d5db; text-align: center; width: 100%; transition: all 0.2s; }
        .filter-button-active { background: #4f46e5; color: white; border-color: #4f46e5; }
        .filter-button-inactive { background: #f3f4f6; color: #6b7280; }
        .emoji-marker-outer { width: 24px!important; height: 24px!important; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .marker-ski { background: #4f46e5; } .marker-hike { background: #b54708; } 
        .marker-climb { background: #dc2626; } .marker-bike { background: #065f46; } .marker-bike-hike { background: #f97316; }
        .emoji-marker-inner { font-size: 10px; background: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; }
        .photo-popup-img { width: 100%; border-radius: 0.4rem; margin-bottom: 0.6rem; object-fit: cover; height: 110px; display: block; }
        .track-label { background: rgba(255, 255, 255, 0.95); border: 2px solid #ef4444; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: 800; color: #ef4444; pointer-events: none; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="map-container">
    <div id="floating-controls">
        <button id="filter-toggle" onclick="toggleMenu(event)">‚öôÔ∏è</button>
        <div id="filter-controls-panel">
            <div class="bg-indigo-50 p-3 rounded-lg flex flex-col gap-2 border border-indigo-100">
                <div class="flex justify-between items-center text-[10px] font-bold text-indigo-900 uppercase">
                    <span>Switch Map @</span>
                    <span id="threshold-display" class="bg-indigo-600 text-white px-2 py-0.5 rounded">13</span>
                </div>
                <input type="range" id="threshold-slider" min="10" max="16" value="13" step="0.5" class="w-full">
            </div>
            <select id="year-select" class="text-sm p-2 border rounded bg-gray-50 font-bold"></select>
            <div class="grid grid-cols-2 gap-2">
                <button class="filter-button filter-button-active" data-activity="ski">‚ùÑÔ∏è Ski</button>
                <button class="filter-button filter-button-active" data-activity="hike">ü•æ Hike</button>
                <button class="filter-button filter-button-active" data-activity="climb">‚õ∞Ô∏è Climb</button>
                <button class="filter-button filter-button-active" data-activity="bike">üö¥ Bike</button>
                <button class="filter-button filter-button-active col-span-2" data-activity="bike+hike">üöµ Bike + Hike</button>
            </div>
            <div class="border-t pt-3 flex flex-col gap-2">
                <button id="hike-layer-btn" class="filter-button filter-button-inactive text-left px-3 text-[10px]">üèîÔ∏è HIKING NETWORK</button>
                <button id="bike-layer-btn" class="filter-button filter-button-inactive text-left px-3 text-[10px]">üö≤ MTB NETWORK</button>
                <button id="clear-tracks-btn" class="filter-button bg-red-600 text-white border-none mt-1" style="display:none;">üóëÔ∏è CLEAR TRACKS</button>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script>
    let map, overviewLayer, detailLayer, hikingLayer, cyclingLayer;
    let currentMarkers = [];
    let loadedTracks = {}; 
    let activeFilters = { ski: true, hike: true, climb: true, bike: true, 'bike+hike': true };
    let activeYear = 'All';
    let isInitialLoad = true;
    let switchThreshold = 13; 

    const getFullUrl = (val, base) => {
        if (!val || val.trim() === "") return null;
        return (val.startsWith('http')) ? val : base + val;
    };

    window.toggleMenu = function(e) {
        const panel = document.getElementById('filter-controls-panel');
        panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
    };

    // --- THE FIX: WAIT FOR DATA ---
    function checkDataAndInit() {
        if (typeof photoMarkers !== 'undefined') {
            console.log("Data loaded! Initializing map...");
            initMap();
        } else {
            console.log("Waiting for data.js...");
            setTimeout(checkDataAndInit, 50); // Check every 50ms
        }
    }

    document.addEventListener('DOMContentLoaded', checkDataAndInit);

    function initMap() {
        const initialPoint = (photoMarkers.length > 0) ? [photoMarkers[0].lat, photoMarkers[0].lon] : [47.0, 12.0];
        map = L.map('map', { center: initialPoint, zoom: 11, zoomControl: false, closePopupOnClick: false });

        overviewLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 });
        detailLayer = L.tileLayer(`https://api.maptiler.com/maps/outdoor-v4/{z}/{x}/{y}@2x.png?key=${MAPTILER_KEY}`, { tileSize: 512, zoomOffset: -1 });
        hikingLayer = L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', { zIndex: 2000 });
        cyclingLayer = L.tileLayer('https://tile.waymarkedtrails.org/mtb/{z}/{x}/{y}.png', { zIndex: 2001 });

        const checkTiles = () => {
            const z = map.getZoom();
            if (z >= switchThreshold) {
                if (!map.hasLayer(detailLayer)) { detailLayer.addTo(map); map.removeLayer(overviewLayer); }
            } else {
                if (!map.hasLayer(overviewLayer)) { overviewLayer.addTo(map); map.removeLayer(detailLayer); }
            }
        };

        map.on('zoomend zoom', checkTiles);
        checkTiles();

        document.getElementById('threshold-slider').oninput = function() {
            switchThreshold = parseFloat(this.value);
            document.getElementById('threshold-display').innerText = switchThreshold;
            checkTiles();
        };

        L.control.zoom({ position: 'bottomleft' }).addTo(map);
        setupEvents();
        populateYearDropdown();
        renderMarkers();
    }

    function setupEvents() {
        const controls = document.getElementById('floating-controls');
        L.DomEvent.disableClickPropagation(controls).disableScrollPropagation(controls);
        map.on('mousedown', () => document.getElementById('filter-controls-panel').style.display = 'none');
        
        document.querySelectorAll('[data-activity]').forEach(btn => {
            btn.onclick = () => {
                activeFilters[btn.dataset.activity] = !activeFilters[btn.dataset.activity];
                btn.classList.toggle('filter-button-active', activeFilters[btn.dataset.activity]);
                renderMarkers();
            };
        });

        document.getElementById('hike-layer-btn').onclick = function() {
            map.hasLayer(hikingLayer) ? map.removeLayer(hikingLayer) : hikingLayer.addTo(map);
            this.classList.toggle('filter-button-active');
        };
        document.getElementById('bike-layer-btn').onclick = function() {
            map.hasLayer(cyclingLayer) ? map.removeLayer(cyclingLayer) : cyclingLayer.addTo(map);
            this.classList.toggle('filter-button-active');
        };
        document.getElementById('clear-tracks-btn').onclick = () => window.clearAllTracks();
    }

    window.loadGpxTrack = function(idx) {
        const p = photoMarkers[idx];
        const url = getFullUrl(p.gpx, BASE_GPX);
        if (loadedTracks[idx]) {
            map.removeLayer(loadedTracks[idx].layer);
            map.removeLayer(loadedTracks[idx].label);
            delete loadedTracks[idx];
            renderMarkers();
        } else {
            new L.GPX(url, {
                async: true,
                marker_options: { startIconUrl: '', endIconUrl: '' },
                polyline_options: { color: '#ef4444', weight: 4 }
            }).on('loaded', e => {
                map.flyToBounds(e.target.getBounds(), { padding: [60, 60] });
                const label = L.tooltip({ permanent: true, direction: 'center', className: 'track-label' })
                    .setContent(p.title).setLatLng(e.target.getBounds().getCenter()).addTo(map);
                loadedTracks[idx] = { layer: e.target, label: label };
                renderMarkers();
            }).addTo(map);
        }
    };

    window.clearAllTracks = function() {
        Object.values(loadedTracks).forEach(t => { map.removeLayer(t.layer); map.removeLayer(t.label); });
        loadedTracks = {};
        renderMarkers();
    };

    function renderMarkers() {
        let openId = null;
        currentMarkers.forEach(m => { if(m.getPopup().isOpen()) openId = m._idx; map.removeLayer(m); });
        currentMarkers = [];
        
        document.getElementById('clear-tracks-btn').style.display = Object.keys(loadedTracks).length > 0 ? 'block' : 'none';

        photoMarkers.filter(p => activeFilters[p.activity] && (activeYear === 'All' || p.year.toString() === activeYear))
        .forEach((p, i) => {
            const idx = photoMarkers.indexOf(p);
            const active = !!loadedTracks[idx];
            const img = getFullUrl(p.img, BASE_IMG);
            const alb = getFullUrl(p.album, BASE_PHOTOS);

            const icon = L.divIcon({
                className: `emoji-marker-outer marker-${p.activity.replace('+', '-')}`,
                html: `<span class="emoji-marker-inner">${p.activity === 'ski' ? '‚ùÑÔ∏è' : p.activity === 'hike' ? 'ü•æ' : p.activity === 'climb' ? '‚õ∞Ô∏è' : p.activity === 'bike' ? 'üö¥' : 'üöµ'}</span>`,
                iconSize: [24, 24]
            });

            const content = `
                <div class="p-1 min-w-[180px]">
                    ${img ? `<img src="${img}" class="photo-popup-img shadow-sm">` : ''}
                    <div class="text-[12px] font-bold text-gray-900 mb-3 leading-tight">${p.title}</div>
                    <div class="flex gap-1.5">
                        ${alb ? `<a href="${alb}" target="_blank" class="flex-1 bg-[#1e1b4b] text-white flex items-center justify-center py-2.5 rounded text-[10px] font-black no-underline shadow-sm hover:bg-black transition-colors">üì∏ PHOTOS</a>` : ''}
                        ${p.gpx ? `<button onclick="loadGpxTrack(${idx})" class="flex-1 ${active ? 'bg-gray-600' : 'bg-emerald-700'} text-white flex items-center justify-center py-2.5 rounded text-[10px] font-black shadow-sm transition-all">${active ? '‚ùå HIDE' : 'üó∫Ô∏è TRACK'}</button>` : ''}
                    </div>
                </div>`;

            const m = L.marker([p.lat, p.lon], { icon }).bindPopup(content).addTo(map);
            m._idx = idx;
            currentMarkers.push(m);
            if((isInitialLoad && i === 0) || openId === idx) m.openPopup();
        });
        isInitialLoad = false;
    }

    function populateYearDropdown() {
        const s = document.getElementById('year-select');
        const yrs = ['All', ...new Set(photoMarkers.map(p => p.year))].sort().reverse();
        yrs.forEach(y => s.add(new Option(y, y)));
        s.onchange = (e) => { activeYear = e.target.value; renderMarkers(); };
    }
</script>
</body>
</html>